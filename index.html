<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>クラウドシフト管理</title>
  <style>
    table, th, td {
      border: 1px solid #ccc;
      border-collapse: collapse;
      padding: 5px;
    }
  </style>
</head>
<body>
  <h1>クラウド対応 シフト管理</h1>
  <label>年: <input type="number" id="year" value="2025"></label>
  <label>月: <input type="number" id="month" value="8" min="1" max="12"></label>
  <button onclick="generateCalendar()">カレンダー生成</button><br><br>

  <label>名前: <input type="text" id="username"></label><br>
  <label>日付: <input type="date" id="date"></label><br>
  <form>
  <label>開始時間:
    <input type="time" id="startTime" step="1800" value="09:00">
  </label>
  <label>終了時間:
    <input type="time" id="endTime" step="1800" value="17:00">
  </label>
</form>


  <button onclick="submitShift()">登録</button>


  <h2>シフト一覧</h2>
  <table id="shiftTable">
    <!-- ヘッダーとデータ行はJavaScriptで生成 -->
  </table>


  <script>
    const startTime = document.getElementById('startTime').value;  // "09:00"
    const endTime = document.getElementById('endTime').value;      // "17:00"
    const shiftTime = `${startTime}〜${endTime}`;

    const SUPABASE_URL = 'https://ppmbtoptcxelwewwompk.supabase.co'; // ←置き換えてください
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBwbWJ0b3B0Y3hlbHdld3dvbXBrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwNjE0NjcsImV4cCI6MjA2OTYzNzQ2N30.Q01_d75sc3j362CMulQwkhtp0SuTzU86X2ElmXPU518';             // ←置き換えてください

    let currentDates = [];

    function generateCalendar() {
  const year = parseInt(document.getElementById('year').value);
  const month = parseInt(document.getElementById('month').value);

  if (!year || !month || month < 1 || month > 12) {
    alert("正しい年と月を入力してください");
    return;
  }

  const table = document.getElementById("shiftTable");
  table.innerHTML = ''; // リセット

  // ヘッダー行作成
  const headerRow = table.insertRow();
  headerRow.insertCell().textContent = "名前";

  const daysInMonth = new Date(year, month, 0).getDate();  // 月末の日付
  currentDates = [];

  for (let day = 1; day <= daysInMonth; day++) {
    const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    currentDates.push(dateStr);

    const th = document.createElement('th');
    th.textContent = `${month}/${day}`;
    headerRow.appendChild(th);
  }

  // データ取得
  fetchShiftsForMonth(year, month);
}

    async function fetchShiftsForMonth(year, month) {
  const monthStr = String(month).padStart(2, '0');
  const res = await fetch(`${SUPABASE_URL}/rest/v1/shifts?select=*`, {
    headers: {
      apikey: SUPABASE_KEY,
      Authorization: `Bearer ${SUPABASE_KEY}`
    }
  });
  const data = await res.json();

  const filtered = data.filter(item => {
    return item.date.startsWith(`${year}-${monthStr}`);
  });

  const userMap = {};
  filtered.forEach(item => {
    if (!userMap[item.username]) {
      userMap[item.username] = {};
    }
    userMap[item.username][item.date] = item.shift_time;
  });

  const table = document.getElementById("shiftTable");

  for (const [username, shifts] of Object.entries(userMap)) {
    const row = table.insertRow();
    row.insertCell().textContent = username;
    currentDates.forEach(date => {
      row.insertCell().textContent = shifts[date] || '';
    });
  }
}



    async function submitShift() {
  const username = document.getElementById('username').value;
  const date = document.getElementById('date').value;
  const start = document.getElementById('startTime').value;
  const end = document.getElementById('endTime').value;
  const shiftTime = `${start}〜${end}`;

  if (!username || !date || !start || !end) {
    alert("すべて入力してください");
    return;
  }

  const res = await fetch(`${SUPABASE_URL}/rest/v1/shifts`, {
    method: 'POST',
    headers: {
      apikey: SUPABASE_KEY,
      Authorization: `Bearer ${SUPABASE_KEY}`,
      'Content-Type': 'application/json',
      Prefer: 'return=representation'
    },
    body: JSON.stringify({ username, date, shift_time: shiftTime })
  });

  if (res.ok) {
    alert('シフトを登録しました');
    generateCalendar();  // 最新の状態で再描画
  } else {
    alert('登録に失敗しました');
  }
}


    window.onload = () => {
    const now = new Date();
    document.getElementById('year').value = now.getFullYear();
    document.getElementById('month').value = now.getMonth() + 1;
    generateCalendar();
  };

  </script>
</body>
</html>

